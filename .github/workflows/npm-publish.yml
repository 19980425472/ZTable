name: Publish Node.js Package to npm

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配语义化版本标签，比如 v1.0.1、v2.3.0

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 配置 Node.js 环境
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x  # 匹配你项目的 Node 版本
          registry-url: 'https://registry.npmjs.org/'  # npm 官方源

      # 3. 安装依赖 + 构建项目（因为你有 build 脚本）
      - name: Install dependencies & Build
        run: |
          npm ci  # 严格安装 package-lock.json 里的依赖
          npm run build  # 执行 tsc 构建，生成 dist 目录

      # 4. 可选：运行测试（保证发布的包是可用的）
      - name: Run tests
        run: npm test  # 执行 jest 测试

      # 5. 发布到 npm（关键步骤）
      - name: Publish to npm
        run: npm publish --access public  # 发布公共包必须加 --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.Z_TABLE }}  # 引用 GitHub Secrets 里的 npm 令牌
